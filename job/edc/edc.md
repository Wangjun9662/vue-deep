### EDC 的迭代与维护
#### 项目概述
EDC（动态组件）是面向美团全公司的前端组件动态化方案。在EDC平台上不仅可以快捷开发、发布、使用和分享组件，也可以使用灰度能力进行组件的灵活分发。同时，组件的迭代更新，无需前端再次发版即可应用，并支持组件跨框架使用。
#### 个人职责
独立负责SDK和平台服务的迭代与维护，时间：202109 - 202312
#### 项目难点
1.服务稳定性保障，支撑日均百万级的访问量。
2.人力短缺的情况下，做好迭代并提供更好的服务。
动作：
1. 功能扩展。
    支持Vue3
    支持web component
2. 性能和稳定性保障。
    发现问题并解决：
    服务端内存泄漏问题。使用了LRU缓存接口的响应数据，随着组件数量的增加，缓存值激增，触发机器的OOM。本质上是不合理的接口设计。
    数据库设计规范性治理。不合理的表设计，导致字段超长溢出。
3. 客户服务和运营，跨团队拉共建资源。
    和用户积极的沟通，及时处理问题，通过回访、问卷，做需求收集，并满足需求。体现在组件数量的增加和增长速度
    共建需求：上线管控能力
    EDC结合低代码平台天河
#### 工作成果
全平台组件数量：2300+
组件最高复用次数：440+，复用次数达20次的组件有16个
开发者800+
接入项目890+

负责期间：组件数量从600 -> 2100，开发者 300 -> 800, 项目 280 -> 890
解决问题数量：200+


实现细节：
1、EDC 实现动态组件的核心原理
    edc-core：
      EDCInstance模块：EDC组件实例，负责组建资源的获取，并启动组件的渲染。
      EDCTemplate模块：管理edc实例，负责组建资源的加载，避免相同组件的资源重复加载，同时模板本身也只会加载一次。
      EDCRegistry模块：负责组建的注册，包括组件基础配置、实例创建，模板创建等
      EDCContext模块：实例上下文管理

      主要流程：
      ……
      请资源和配置的详细流程：
      1. 获取请求配置。根据用户的配置，如是否延迟渲染、是否需要缓存接口请求数据、extendKeys等，整合接口请求参数。
      2. 发起请求。调用接口发起请求，请求数据会根据配置是否缓存到localStorage中。
      3. 处理接口响应数据:
        3.1 处理子依赖。递归处理，创建template并加载资源，同时将该template作为当前组件的依赖。
        3.2 处理资源（js/css）。创建style和script标签，其中js资源会在创建的沙箱中执行
      4. 沙箱环境构造
        沙箱选型：
          1. new Function
            * 无法访问全局变量，有安全风险
            * 无法对代码执行进行更细粒度的控制
          2. 使用Iframe构造
            * 性能开销
            * 通信不方便
          3. 使用node的vm构造
            * 精确控制沙箱内代码执行环境，限制其对外部环境的访问
            * 有丰富的api来管理沙箱
          4. 闭包 + Proxy（采用方案）
            * 使用Proxy代理window
            * 插件机制可以让用户自行注册可以访问的全局对象
            * 闭包函数，将代理的window当做参数传进去，同时，加入自动化注册组件方法（获取组件的setup钩子并存储，后续再template ready后执行该钩子进行组件的渲染），并且重写require方法，让其可以从宿主项目获取

    动态配置获取与处理？
      通过接口获取到组件的资源和配置之后，将配置保存到了context.state中，用户在组件中可以通过context.state获取并使用
    设计中的难点，权衡取舍？
    性能：缓存
    沙箱：选型
    热更：实现和选型
2、cli实现
    热更新：
    1、启动koa服务，通过接口提供组件资源
    2、使用rollup监听并构建。合并配置 -> rollup.watch()构建并监听 -> 监听构建结果 -> 构建完毕后，刷新组件
      刷新组件：
        0、构建完毕后的资源使用数据流传给hot-reload接口并返回。
        1、监听组件的刷新。使用EventSource，接口数据刷新后，通知客户端
        2、替换组件。使用新收到的组件替换原有的组件完成更新

    发布
      1、选择发布版本
      2、构建
      3、发布：检查权限、js和css上传cdn、信息存储数据库
      4、完事儿
3、跨框架原理
    dom模式和组件模式
4、Vue3支持
    api的改动，新的兼容
    cli的兼容